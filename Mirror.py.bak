import datetime

from PyQt5 import QtGui
from PyQt5.QtCore import Qt, pyqtSlot
from PyQt5.QtGui import QCursor
from PyQt5.QtWidgets import QApplication, QLabel, QMainWindow, QAction
from idna import unichr

from TrainData import INDEXES, TrainData
from WeatherData import WeatherData

firstRowYChord = 120
rowOffset = 40
cellOffset = 110


class Window(QMainWindow):

    def __init__(self):
        super(Window, self).__init__()
        self.setWindowTitle("Smart mirror")
        self.setAutoFillBackground(True)
        p = self.palette()
        p.setColor(self.backgroundRole(), Qt.black)
        self.degree = unichr(176)
        self.setPalette(p)

        self.prevTrainLabel = QLabel(self)
        self.prevTrainLabel1 = QLabel(self)
        self.prevTrainLabel2 = QLabel(self)
        self.prevTrainLabel3 = QLabel(self)

        self.nextTrainLabel = QLabel(self)
        self.nextTrainLabel1 = QLabel(self)
        self.nextTrainLabel2 = QLabel(self)
        self.nextTrainLabel3 = QLabel(self)

        self.nextTrain1Label = QLabel(self)
        self.nextTrain1Label1 = QLabel(self)
        self.nextTrain1Label2 = QLabel(self)
        self.nextTrain1Label3 = QLabel(self)

        self.nextTrain2Label = QLabel(self)
        self.nextTrain2Label1 = QLabel(self)
        self.nextTrain2Label2 = QLabel(self)
        self.nextTrain2Label3 = QLabel(self)

        self.startTime = QLabel(self)
        self.lateTime = QLabel(self)
        self.arrivalTime = QLabel(self)
        self.arrivalStation = QLabel(self)
        self.line = QLabel(self)
        self.time = QLabel(self)
        self.date = QLabel(self)

        self.temperature = QLabel(self)
        self.weather = []
        for i in range(0, 3):
            self.weather.append(QLabel(self))
        self.clouds = QLabel(self)
        self.wind = QLabel(self)

        self.trainLabelFont = QtGui.QFont("Times", 20, QtGui.QFont.Normal)
        self.timeLabelFont = QtGui.QFont("Times", 60, QtGui.QFont.Normal)
        self.dateLabelFont = QtGui.QFont("Times", 15, QtGui.QFont.Normal)

        exit_action = QAction("", self)
        exit_action.setShortcut("Ctrl+Q")
        exit_action.setStatusTip('')
        exit_action.triggered.connect(self.showNormalAndExit)
        exit_full_screen = QAction("", self)
        exit_full_screen.setShortcut("Ctrl+X")
        exit_full_screen.setStatusTip('')
        exit_full_screen.triggered.connect(self.showNormal)
        return_full_screen = QAction("", self)
        return_full_screen.setShortcut("Ctrl+A")
        return_full_screen.setStatusTip('')
        return_full_screen.triggered.connect(self.showFullScreen)
        self.statusBar()
        self.setStyleSheet("""
            QMenuBar {
                background-color: rgb(0,0,0);
                color: rgb(255,255,255);
                border: 1px solid #000;
            }

            QMenuBar::item {
                background-color: rgb(0,0,0);
                color: rgb(255,255,255);
            }

            QMenuBar::item::selected {
                background-color: rgb(0,0,0);
            }

            QMenu {
                background-color: rgb(0,0,0);
                color: rgb(255,255,255);
                border: 1px solid #000;           
            }

            QMenu::item::selected {
                background-color: rgb(0,0,0);
            }
        """)

        mainMenu = self.menuBar()
        fileMenu = mainMenu.addMenu('')
        fileMenu.addAction(exit_action)
        fileMenu.addAction(exit_full_screen)
        fileMenu.addAction(return_full_screen)
        mainMenu.resize(0, 0)

        self.colorWhite = 'color: white'
        self.colorGrey = 'color: grey'
        self.colorDarkGrey = 'color: #1e1e1e'

        self.showFullScreen()
        self.trainData = TrainData()
        self.weatherData = WeatherData()
        self.refreshWindowSize()
        self.setTrainTexts()
        self.initTrainsLabel()
        self.initDateTimeLabels()
        self.initWeatherLabels()
        self.setTrains()
        self.setDateTime()
        self.setWeather()

    def initTrainsLabel(self):
        self.prevTrainLabel.setStyleSheet(self.colorWhite)
        self.prevTrainLabel.move(self.firstRowXChord, firstRowYChord + rowOffset)
        self.prevTrainLabel.setFont(self.trainLabelFont)
        self.prevTrainLabel1.move(self.firstRowXChord + cellOffset, firstRowYChord + rowOffset)
        self.prevTrainLabel1.setStyleSheet(self.colorWhite)
        self.prevTrainLabel1.setFont(self.trainLabelFont)
        self.prevTrainLabel2.move(self.firstRowXChord + 2 * cellOffset, firstRowYChord + rowOffset)
        self.prevTrainLabel2.setStyleSheet(self.colorWhite)
        self.prevTrainLabel2.setFont(self.trainLabelFont)
        self.prevTrainLabel3.move(self.firstRowXChord + 3 * cellOffset, firstRowYChord + rowOffset)
        self.prevTrainLabel3.setStyleSheet(self.colorWhite)
        self.prevTrainLabel3.setFont(self.trainLabelFont)
        self.prevTrainLabel3.resize(200, 30)

        self.nextTrainLabel.move(self.firstRowXChord, firstRowYChord + 2 * rowOffset)
        self.nextTrainLabel.setStyleSheet(self.colorWhite)
        self.nextTrainLabel.setFont(self.trainLabelFont)
        self.nextTrainLabel1.move(self.firstRowXChord + cellOffset, firstRowYChord + 2 * rowOffset)
        self.nextTrainLabel1.setStyleSheet(self.colorWhite)
        self.nextTrainLabel1.setFont(QtGui.QFont("Times", 20, QtGui.QFont.Bold))
        self.nextTrainLabel2.move(self.firstRowXChord + 2 * cellOffset, firstRowYChord + 2 * rowOffset)
        self.nextTrainLabel2.setStyleSheet(self.colorWhite)
        self.nextTrainLabel2.setFont(self.trainLabelFont)
        self.nextTrainLabel3.move(self.firstRowXChord + 3 * cellOffset, firstRowYChord + 2 * rowOffset)
        self.nextTrainLabel3.setStyleSheet(self.colorWhite)
        self.nextTrainLabel3.setFont(self.trainLabelFont)
        self.nextTrainLabel3.resize(200, 35)

        self.nextTrain1Label.move(self.firstRowXChord, firstRowYChord + 3 * rowOffset)
        self.nextTrain1Label.setStyleSheet(self.colorGrey)
        self.nextTrain1Label.setFont(self.trainLabelFont)
        self.nextTrain1Label1.move(self.firstRowXChord + cellOffset, firstRowYChord + 3 * rowOffset)
        self.nextTrain1Label1.setStyleSheet(self.colorGrey)
        self.nextTrain1Label1.setFont(self.trainLabelFont)
        self.nextTrain1Label2.move(self.firstRowXChord + 2 * cellOffset, firstRowYChord + 3 * rowOffset)
        self.nextTrain1Label2.setStyleSheet(self.colorGrey)
        self.nextTrain1Label2.setFont(self.trainLabelFont)
        self.nextTrain1Label3.move(self.firstRowXChord + 3 * cellOffset, firstRowYChord + 3 * rowOffset)
        self.nextTrain1Label3.setStyleSheet(self.colorGrey)
        self.nextTrain1Label3.setFont(self.trainLabelFont)
        self.nextTrain1Label3.resize(200, 35)

        self.nextTrain2Label.move(self.firstRowXChord, firstRowYChord + 4 * rowOffset)
        self.nextTrain2Label.setStyleSheet(self.colorDarkGrey)
        self.nextTrain2Label.setFont(self.trainLabelFont)
        self.nextTrain2Label1.move(self.firstRowXChord + cellOffset, firstRowYChord + 4 * rowOffset)
        self.nextTrain2Label1.setStyleSheet(self.colorDarkGrey)
        self.nextTrain2Label1.setFont(self.trainLabelFont)
        self.nextTrain2Label2.move(self.firstRowXChord + 2 * cellOffset, firstRowYChord + 4 * rowOffset)
        self.nextTrain2Label2.setStyleSheet(self.colorDarkGrey)
        self.nextTrain2Label2.setFont(self.trainLabelFont)
        self.nextTrain2Label3.move(self.firstRowXChord + 3 * cellOffset, firstRowYChord + 4 * rowOffset)
        self.nextTrain2Label3.setStyleSheet(self.colorDarkGrey)
        self.nextTrain2Label3.setFont(self.trainLabelFont)
        self.nextTrain2Label3.resize(200, 35)

    def setTrains(self):
        try:
            self.trainData.refreshTrainList()
        except:
            print('Exception during train data request')

        if self.trainData.getPrevTrain() is not None:
            self.prevTrainLabel.setText(str(self.trainData.getPrevTrain()[INDEXES["Indulás"]]["Indulás"]))
            self.prevTrainLabel1.setText(str(self.trainData.getPrevTrain()[INDEXES["Késés"]]["Késés"]))
            self.prevTrainLabel2.setText(str(self.trainData.getPrevTrain()[INDEXES["Érkezés"]]["Érkezés"]))
            self.prevTrainLabel3.setText(str(self.trainData.getPrevTrain()[INDEXES["Végállomás"]]["Végállomás"]))
        else:
            self.prevTrainLabel.setText("")
            self.prevTrainLabel1.setText("")
            self.prevTrainLabel2.setText("")
            self.prevTrainLabel3.setText("")

        if self.trainData.getNextTrains()[0] is not None:
            self.nextTrainLabel.setText(str(self.trainData.getNextTrains()[0][INDEXES["Indulás"]]["Indulás"]))
            self.nextTrainLabel1.setText(str(self.trainData.getNextTrains()[0][INDEXES["Késés"]]["Késés"]))
            self.nextTrainLabel2.setText(str(self.trainData.getNextTrains()[0][INDEXES["Érkezés"]]["Érkezés"]))
            self.nextTrainLabel3.setText(str(self.trainData.getNextTrains()[0][INDEXES["Végállomás"]]["Végállomás"]))
        else:
            self.nextTrainLabel.setText("")
            self.nextTrainLabel1.setText("")
            self.nextTrainLabel2.setText("")
            self.nextTrainLabel3.setText("")

        if self.trainData.getNextTrains()[1] is not None:
            self.nextTrain1Label.setText(str(self.trainData.getNextTrains()[1][INDEXES["Indulás"]]["Indulás"]))
            self.nextTrain1Label1.setText(str(self.trainData.getNextTrains()[1][INDEXES["Késés"]]["Késés"]))
            self.nextTrain1Label2.setText(str(self.trainData.getNextTrains()[1][INDEXES["Érkezés"]]["Érkezés"]))
            self.nextTrain1Label3.setText(str(self.trainData.getNextTrains()[1][INDEXES["Végállomás"]]["Végállomás"]))
        else:
            self.nextTrain1Label.setText("")
            self.nextTrain1Label1.setText("")
            self.nextTrain1Label2.setText("")
            self.nextTrain1Label3.setText("")

        if self.trainData.getNextTrains()[2] is not None:
            self.nextTrain2Label.setText(str(self.trainData.getNextTrains()[2][INDEXES["Indulás"]]["Indulás"]))
            self.nextTrain2Label1.setText(str(self.trainData.getNextTrains()[2][INDEXES["Késés"]]["Késés"]))
            self.nextTrain2Label2.setText(str(self.trainData.getNextTrains()[2][INDEXES["Érkezés"]]["Érkezés"]))
            self.nextTrain2Label3.setText(str(self.trainData.getNextTrains()[2][INDEXES["Végállomás"]]["Végállomás"]))
        else:
            self.nextTrain2Label.setText("")
            self.nextTrain2Label1.setText("")
            self.nextTrain2Label2.setText("")
            self.nextTrain2Label3.setText("")

    def setTrainTexts(self):
        self.startTime.setText("Indulás")
        self.startTime.setStyleSheet(self.colorWhite)
        self.startTime.setFont(self.trainLabelFont)
        self.startTime.move(self.firstRowXChord, firstRowYChord)
        self.lateTime.setText("Késés")
        self.lateTime.setStyleSheet(self.colorWhite)
        self.lateTime.setFont(self.trainLabelFont)
        self.lateTime.move(self.firstRowXChord + cellOffset, firstRowYChord)
        self.arrivalTime.setText("Érkezés")
        self.arrivalTime.setStyleSheet(self.colorWhite)
        self.arrivalTime.setFont(self.trainLabelFont)
        self.arrivalTime.move(self.firstRowXChord + 2 * cellOffset, firstRowYChord)
        self.arrivalStation.setText("Végállomás")
        self.arrivalStation.setStyleSheet(self.colorWhite)
        self.arrivalStation.setFont(self.trainLabelFont)
        self.arrivalStation.resize(200, 35)
        self.arrivalStation.move(self.firstRowXChord + 3 * cellOffset, firstRowYChord)
        self.line.setText("---------------------------------------------------")
        self.line.move(self.firstRowXChord, firstRowYChord + rowOffset + 20)
        self.line.setStyleSheet(self.colorWhite)
        self.line.setFont(self.trainLabelFont)
        self.line.resize(1000, 35)

    def initDateTimeLabels(self):
        self.time.move(self.firstRowXChord, 20)
        self.time.setStyleSheet(self.colorWhite)
        self.time.setFont(self.timeLabelFont)
        self.time.resize(260, 65)
        self.date.move(self.firstRowXChord + 270, 45)
        self.date.setStyleSheet(self.colorWhite)
        self.date.setFont(self.dateLabelFont)
        self.date.resize(400, 65)

    def setDateTime(self):
        now = datetime.datetime.now()
        minute = now.minute

        if minute < 10:
            minute = '0' + str(minute)

        month = now.month
        if month < 10:
            month = '0' + str(month)
        day = now.day
        if day < 10:
            day = '0' + str(day)
        print(now.hour, ":", now.minute)
        self.date.setText(str(now.year) + '.' + str(month) + '.' + str(day))
        self.time.setText(str(now.hour) + ' : ' + str(minute))

    def initWeatherLabels(self):
        self.temperature.setStyleSheet(self.colorWhite)
        self.temperature.move(self.firstRowXChord + 5 * cellOffset, 20)
        self.temperature.setFont(self.timeLabelFont)
        self.temperature.resize(230, 65)
        for i in range(0, 3):
            self.weather[i].setStyleSheet(self.colorWhite)
            self.weather[i].move(self.firstRowXChord + 5 * cellOffset, firstRowYChord + i * rowOffset)
            self.weather[i].setFont(self.trainLabelFont)
            self.weather[i].resize(230, 35)
        self.clouds.setStyleSheet(self.colorWhite)
        self.clouds.move(self.firstRowXChord + 5 * cellOffset, firstRowYChord + 3 * rowOffset)
        self.clouds.setFont(self.trainLabelFont)
        self.clouds.resize(230, 35)
        self.wind.setStyleSheet(self.colorWhite)
        self.wind.move(self.firstRowXChord + 5 * cellOffset, firstRowYChord + 4 * rowOffset)
        self.wind.setFont(self.trainLabelFont)
        self.wind.resize(230, 35)

    def setWeather(self):
        weatherData = self.weatherData.refreshWeatherData()
        self.temperature.setText(str(weatherData['main']['temp']) + self.degree + 'C')
        a = 0
        for weather in weatherData['weather']:
            self.weather[a].setText(weather['description'])
            a += 1
        for i in range(a, 3):
            self.weather[a].setText('')
        self.clouds.setText("Felhőzet: " + str(weatherData['clouds']['all']) + '%')
        self.wind.setText("Szél: " + str(weatherData['wind']['speed']) + " meter/sec")

    def updateTrainsAndDate(self):
        self.setTrains()
        self.setDateTime()

    def setwindowSize(self):
        self.showNormal()

    @pyqtSlot()
    def exiting(self):
        print("Exit")
        self.t.cancel()
        sys.exit()

    def showNormalAndExit(self):
        self.showNormal()
        self.exiting()

    def refreshWindowSize(self):
        self.firstRowXChord = self.width()
        print("self.width()", self.width())
        print("self.height()", self.height())
        print("self.firstRowXChord: ", self.firstRowXChord)

    def startRefreshThread(self):
        try:
            self.updateTrainsAndDate()
            self.setWeather()
        except:
            print('Train update exception')
        self.t = threading.Timer(30, self.startRefreshThread)
        self.t.start()


if __name__ == "__main__":
    import sys
    import threading

    app = QApplication(sys.argv)
    app.setOverrideCursor(QCursor(Qt.BlankCursor))
    GUI = Window()
    GUI.refreshWindowSize()
    GUI.startRefreshThread()
    sys.exit(app.exec_())
